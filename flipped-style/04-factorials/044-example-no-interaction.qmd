---
title: "Module 4: Factorial Treatment Structure"
subtitle: "Example: No Interaction, interpret Main Effects"
format: 
  revealjs:
    # theme: simple # other modern-ish options: dark, simple, solarized
    theme: simple
    slide-number: c/t 
    # chalkboard: true # lets you draw on top of slides (keyboard: c) or open a board (b)
    width: 1200
    height: 675
    css: modern-slides.css
    auto-stretch: false
    embed-resources: true
# format: 
#   html:
#     toc: true
#   pdf:
#     toc: false
execute: 
  warning: false
  message: false
---

## Example 4.2: Bakery

```{=html}
<style>
.reveal .slides .small table { font-size: 0.78em; line-height:1.05; }
.reveal .slides .small table th, .reveal .slides .small table td { padding:6px 8px; }
</style>
```

```{r}
library(tidyverse)
bakery_data <- read_csv("data/04_bakery_data.csv") %>% 
  mutate(height = factor(height, levels = c("bottom", "middle", "top")),
         width = factor(width, levels = c("regular", "wide")))
```

::::: columns
::: column
**Treatment Structure:** 3 x 2 Full Factorial

-   Shelf Height (Bottom, Middle, Top)
-   Shelf Width (Regular, Wide)

**Design Structure:** CRD with r = 2 stores per treatment combination.

**Response:** Bread Sales
:::

::: column
```{r}
#| fig-align: center
#| out-width: 90%

library(tidyverse)
library(emmeans)
library(multcompView)
library(multcomp)

knitr::include_graphics("images/042-bakerys.png")
```
:::
:::::

## The Treatment Effects Model (Two-way Factorial)

<span style="font-size:0.7em"> $$y_{ijk}=\mu+\alpha_i+\beta_j+\alpha\beta_{ij}+\epsilon_{ijk} \text{ with } \epsilon_{ijk} \sim \text{ iid }N(0,\sigma^2)$$
</span>

<span style="font-size:0.7em">
$$\text{for } i=1,2,3,…,a; j=1,2,…,b;   k=1,2,….,r$$
</span>

- <span style="font-size:0.7em">$y_{ijk}$: is the response (sales) from the $k^{th}$ experimental unit (store) using the $i^{th}$ level of Factor A (height) and $j^{th}$ level of Factor B (width) combination</span>
-   <span style="font-size:0.7em">$\mu$: is the grand/overall mean sales</span>
-   <span style="font-size:0.7em">$\alpha_i$: is the effect of the $i^{th}$ level of factor A (height)</span>
-   <span style="font-size:0.7em">$\beta_j$: is the effect of the $j^{th}$ level of factor B (width)</span>
-   <span style="font-size:0.7em">$\alpha\beta_{ij}$: is the interaction effect between the $i^{th}$ level of A (height) and $j^{th}$ level of B (width)</span>
-   <span style="font-size:0.7em">$\epsilon_{ijk}$: the experimental error associated with the $k^{th}$ experimental unit (store) using the $i^{th}$ level of Factor A (height) and $j^{th}$ level of Factor B (width) combination </span>

## Decision Flowchart

```{r}
#| fig-align: center
#| out-width: 70%
knitr::include_graphics("images/two-way-decision-flowchart.png")
```

## What are we testing?

**Interaction**

$$H_0:\text{ All } \alpha\beta_{ij} = 0 \text{  vs  } H_A: \text{At least one } \alpha\beta_{ij} \ne 0$$

**Main Effect of A**

$$H_0:\text{ All } \alpha_{i} = 0 \text{  vs  } H_A: \text{At least one } \alpha_{i} \ne 0$$

**Main Effect of B**

$$H_0:\text{ All } \beta_{j} = 0 \text{  vs  } H_A: \text{At least one } \beta_{j} \ne 0$$

## ANOVA

::::: columns
::: column
```{r}
#| echo: true
options(contrasts = c("contr.sum", "contr.poly"))
bakery_mod <- lm(sales ~ height + width + height:width, data = bakery_data)
anova(bakery_mod)
```
:::
::: column
```{r}
#| fig-align: center
#| out-width: 80%
knitr::include_graphics("images/bakery-mod-jmp2.png")
knitr::include_graphics("images/bakery-mod-jmp3.png")
```
:::
::::

## Do these results make sense?

Inspecting the interaction plot between height and width on bread sales, does there visually appear to be a significant interaction?

```{r}
#| fig-align: center
#| height: 4,
#| width: 4
#| out-width: 50%
emmip(bakery_mod, width ~ height, CIs = TRUE, adjust = "tukey") +
  labs(y = "Bread Sales",
       x = "height")
```

## Where should we proceed?

1. Interaction: We do not have enough evidence of a significant interaction effect between shelf height and shelf width on bread sales (F = 1.16; df = 2,6; p = 0.375).
2. Width Main: We do not have enough evidence of a significant main effect of shelf width on bread sales (F = 1.16; df = 1,6; p = 0.323).
3. **Height Main**: We do have evidence of a significant main effect of height on bread sales (F = 74.7; df = 2, 6; p < 0.0001).
 
 > What are the marginal mean sales for each height (sig main effect)?
 > Which heights differ?
 
## R: Marginal Height LSMEANS

:::: columns
::: column
```{r}
#| message: true
#| echo: true
library(emmeans)
height_lsmeans <- emmeans(bakery_mod, specs = ~ height) 
height_lsmeans
```
:::
::: column
```{r}
#| echo: true
#| fig-height: 5
#| fig-width: 5
emmip(bakery_mod, ~ height, CIs = TRUE, adjust = "tukey") +
  labs(y = "Bread Sales",
       x = "height")
```
:::
::::

## R: Height pairwise comparisons

:::: columns
::: column
```{r}
#| echo: true
pairs(height_lsmeans, adjust = "tukey", infer = c(T,T))
```
:::
::: column
```{r}
#| echo: true
library(multcomp)
cld(height_lsmeans, decreasing = F, Letters = LETTERS, adjust = "tukey")
```
:::
::::


## JMP: Main Effect of Height

:::: columns
::: column
```{r}
knitr::include_graphics("images/bakery-height-pairwise.png")
```
:::
::: column
```{r}
#| fig-align: center
#| out-width: 80%
knitr::include_graphics("images/bakery-height-plot.png")
```
:::
::::


## What can we conclude?

+ For bread placed on the middle shelf, the estimated mean bread sales is 67 (s.e. = 1.61).
+ This is estimated to be 25 more sales than for bread placed on the top shelf (t = 10.99; df = 6; p < 0.0001) and 23 more sales than for bread placed on the bottom shelf (t = 10.12; df = 6; p = 0.0001).






